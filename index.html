<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spotify Clone Completo</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <!-- Vibrant.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/node-vibrant/3.2.0/vibrant.min.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      background-color: #121212;
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    #capa {
      animation: none !important;
      transform: none !important;
    }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <!-- HEADER -->
  <header class="p-4 border-b border-gray-700 flex justify-between items-center">
    <h1 class="text-2xl font-bold select-none">Spotify Clone</h1>
    <div id="user-section" class="flex items-center space-x-3 hidden">
      <img id="user-photo" class="w-10 h-10 rounded-full" src="" alt="Foto usuário" />
      <span id="user-name" class="font-semibold"></span>
      <button id="btn-logout" class="ml-4 px-3 py-1 bg-red-600 rounded hover:bg-red-700 transition text-sm font-semibold">Sair</button>
    </div>
    <button id="btn-login-google" class="px-4 py-2 bg-green-600 rounded hover:bg-green-700 transition text-white font-semibold">Entrar com Google</button>
  </header>

  <!-- CRIAÇÃO DE PLAYLIST -->
  <section id="criar-playlist-section" class="p-4 border-b border-gray-700 max-w-4xl mx-auto w-full hidden">
    <h2 class="text-xl font-bold mb-3 select-none">Criar nova playlist</h2>
    <form id="form-playlist" class="flex gap-3 flex-wrap">
      <input
        type="text"
        id="input-titulo"
        placeholder="Título da playlist"
        required
        class="flex-grow rounded px-3 py-2 bg-gray-900 text-white border border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500"
      />
      <input
        type="url"
        id="input-capa"
        placeholder="URL da capa da playlist (imagem)"
        required
        class="flex-grow rounded px-3 py-2 bg-gray-900 text-white border border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500"
      />
      <input
        type="url"
        id="input-audio"
        placeholder="URL da música (mp3)"
        required
        class="flex-grow rounded px-3 py-2 bg-gray-900 text-white border border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500"
      />
      <button
        type="submit"
        class="bg-green-600 hover:bg-green-700 transition rounded px-5 py-2 font-bold"
      >
        Criar
      </button>
    </form>
  </section>

  <!-- LISTA DE PLAYLISTS -->
  <main class="flex-grow p-4 max-w-4xl mx-auto w-full overflow-y-auto">
    <h2 class="text-2xl font-bold mb-4 select-none">Suas playlists</h2>
    <div id="playlistsContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-5"></div>
  </main>

  <!-- PLAYER FIXO -->
  <footer
    id="player-footer"
    class="fixed bottom-0 left-0 right-0 bg-[#1e1e1e] text-white px-5 py-3 flex items-center justify-between space-x-4 transition-colors duration-700"
  >
    <div class="flex items-center gap-4 min-w-[200px] max-w-[350px]">
      <img id="capa" src="" alt="Capa da música" class="w-16 h-16 rounded" />
      <div class="flex flex-col truncate">
        <span id="nomeMusica" class="font-semibold truncate">-</span>
        <span id="nomePlaylist" class="text-gray-400 text-sm truncate">-</span>
      </div>
    </div>

    <div class="flex flex-col flex-grow max-w-xl">
      <input
        type="range"
        id="barraProgresso"
        min="0"
        value="0"
        step="0.01"
        class="w-full accent-green-500 cursor-pointer"
      />
      <div class="flex justify-between text-xs text-gray-400 select-none mt-1">
        <span id="tempoAtual">0:00</span>
        <span id="tempoTotal">0:00</span>
      </div>
    </div>

    <button
      id="botaoPlayPause"
      aria-label="Tocar / Pausar"
      class="text-green-500 text-2xl hover:text-green-600 transition"
    >
      <i id="iconePlayPause" class="fas fa-play"></i>
    </button>

    <audio id="audio" preload="auto"></audio>
  </footer>

  <script>
    // CONFIGURAÇÃO FIREBASE (substitua pelos seus dados!)
    const firebaseConfig = {
      apiKey: "AIzaSyA7n1M1DFVZrkOqEB6WAlTeg_qL4yYvTxs",
      authDomain: "spotify-eaac3.firebaseapp.com",
      projectId: "spotify-eaac3",
      storageBucket: "spotify-eaac3.appspot.com",
      messagingSenderId: "262950105793",
      appId: "1:262950105793:web:87ca0380049c7de4649a40"
    };

    // Inicializa Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ELEMENTOS
    const btnLogin = document.getElementById('btn-login-google');
    const btnLogout = document.getElementById('btn-logout');
    const userSection = document.getElementById('user-section');
    const userPhoto = document.getElementById('user-photo');
    const userName = document.getElementById('user-name');
    const criarPlaylistSection = document.getElementById('criar-playlist-section');

    const playlistsContainer = document.getElementById('playlistsContainer');
    const formPlaylist = document.getElementById('form-playlist');
    const inputTitulo = document.getElementById('input-titulo');
    const inputCapa = document.getElementById('input-capa');
    const inputAudio = document.getElementById('input-audio');

    const audio = document.getElementById('audio');
    const capaPlayer = document.getElementById('capa');
    const nomeMusica = document.getElementById('nomeMusica');
    const nomePlaylist = document.getElementById('nomePlaylist');
    const botaoPlayPause = document.getElementById('botaoPlayPause');
    const iconePlayPause = document.getElementById('iconePlayPause');
    const barraProgresso = document.getElementById('barraProgresso');
    const tempoAtual = document.getElementById('tempoAtual');
    const tempoTotal = document.getElementById('tempoTotal');
    const playerFooter = document.getElementById('player-footer');

    let tocando = false;
    let playlistAtual = null;
    let playlistIdAtual = null;

    // Atualiza progress bar e tempo
    audio.addEventListener('timeupdate', () => {
      barraProgresso.value = audio.currentTime;
      tempoAtual.textContent = formatarTempo(audio.currentTime);
    });
    audio.addEventListener('loadedmetadata', () => {
      barraProgresso.max = audio.duration;
      tempoTotal.textContent = formatarTempo(audio.duration);
    });

    barraProgresso.addEventListener('input', () => {
      audio.currentTime = barraProgresso.value;
    });

    botaoPlayPause.addEventListener('click', () => {
      if (tocando) audio.pause();
      else audio.play();
    });

    audio.addEventListener('play', () => {
      tocando = true;
      iconePlayPause.classList.replace('fa-play', 'fa-pause');
      botaoPlayPause.classList.add('text-white');
      botaoPlayPause.classList.remove('text-green-500');
    });
    audio.addEventListener('pause', () => {
      tocando = false;
      iconePlayPause.classList.replace('fa-pause', 'fa-play');
      botaoPlayPause.classList.remove('text-white');
      botaoPlayPause.classList.add('text-green-500');
    });

    // Formata tempo em mm:ss
    function formatarTempo(segundos) {
      const min = Math.floor(segundos / 60);
      const seg = Math.floor(segundos % 60).toString().padStart(2, '0');
      return `${min}:${seg}`;
    }

    // Login Google
    btnLogin.addEventListener('click', () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .catch((error) => alert("Erro no login: " + error.message));
    });

    btnLogout.addEventListener('click', () => {
      auth.signOut();
    });

    // Atualiza UI e exibe playlists ao mudar estado do usuário
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        btnLogin.style.display = 'none';
        userSection.style.display = 'flex';
        criarPlaylistSection.style.display = 'block';

        userPhoto.src = user.photoURL;
        userName.textContent = user.displayName;

        carregarPlaylists(user.uid);
      } else {
        btnLogin.style.display = 'inline-block';
        userSection.style.display = 'none';
        criarPlaylistSection.style.display = 'none';
        playlistsContainer.innerHTML = '';
        pararMusica();
      }
    });

    // Carrega playlists do usuário no Firestore
    async function carregarPlaylists(uid) {
      playlistsContainer.innerHTML = '';
      const snapshot = await db.collection('playlists').where('uid', '==', uid).get();
      snapshot.forEach(doc => {
        const data = doc.data();
        adicionarCardPlaylist(doc.id, data);
      });
    }

    // Cria card da playlist na tela
    function adicionarCardPlaylist(id, playlist) {
      const div = document.createElement('div');
      div.className = 'bg-gray-900 rounded-md p-3 cursor-pointer hover:bg-gray-800 flex flex-col items-center gap-2 shadow-lg';
      div.innerHTML = `
        <img src="${playlist.capa}" alt="${playlist.titulo}" class="w-36 h-36 rounded shadow-md object-cover" />
        <p class="text-center font-semibold text-lg truncate w-full">${playlist.titulo}</p>
      `;
      div.addEventListener('click', () => {
        tocarPlaylist(id, playlist);
      });
      playlistsContainer.appendChild(div);
    }

    // Tocar música da playlist selecionada
    function tocarPlaylist(id, playlist) {
      playlistAtual = playlist;
      playlistIdAtual = id;

      audio.src = playlist.audio;
      audio.play();

      capaPlayer.src = playlist.capa;
      nomeMusica.textContent = playlist.titulo;
      nomePlaylist.textContent = ""; // artista não usado

      atualizarCorPlayer(playlist.capa);
    }

    // Atualiza cor do player com Vibrant.js
    function atualizarCorPlayer(imagem) {
      Vibrant.from(imagem).getPalette()
        .then(palette => {
          const cor = palette.Vibrant ? palette.Vibrant.getHex() : '#1e1e1e';
          playerFooter.style.backgroundColor = cor;
        })
        .catch(() => {
          playerFooter.style.backgroundColor = '#1e1e1e';
        });
    }

    // Parar música e resetar player
    function pararMusica() {
      audio.pause();
      audio.src = "";
      capaPlayer.src = "";
      nomeMusica.textContent = "-";
      nomePlaylist.textContent = "-";
      playerFooter.style.backgroundColor = '#1e1e1e';
    }

    // Evento criação playlist
    formPlaylist.addEventListener('submit', async e => {
      e.preventDefault();
      if (!inputTitulo.value || !inputCapa.value || !inputAudio.value) return alert('Preencha todos os campos');

      const user = auth.currentUser;
      if (!user) return alert('Faça login antes.');

      try {
        await db.collection('playlists').add({
          uid: user.uid,
          titulo: inputTitulo.value.trim(),
          capa: inputCapa.value.trim(),
          audio: inputAudio.value.trim(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        });

        alert('Playlist criada com sucesso!');
        formPlaylist.reset();
        carregarPlaylists(user.uid);
      } catch (err) {
        alert('Erro ao criar playlist: ' + err.message);
      }
    });
  </script>
</body>
</html>
