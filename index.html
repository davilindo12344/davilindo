playlistForm.onsubmit = async (e) => {
  e.preventDefault();

  const nomeMusica = playlistForm.nome.value.trim();
  const capaFile = playlistForm.capa.files[0];
  const musicaFile = playlistForm.musica.files[0];
  const isPublica = publicaCheck.checked;

  if (!nomeMusica || !capaFile || !musicaFile) {
    alert("Preencha todos os campos!");
    return;
  }

  try {
    // Desabilita botão para evitar múltiplos envios
    const btn = playlistForm.querySelector("button[type='submit']");
    btn.disabled = true;
    btn.textContent = "Enviando...";

    // Prefixa os nomes dos arquivos para evitar sobrescritas
    const timestamp = Date.now();
    const capaRef = storage.ref(`capas/${timestamp}_${capaFile.name}`);
    const musicaRef = storage.ref(`musicas/${timestamp}_${musicaFile.name}`);

    await capaRef.put(capaFile);
    await musicaRef.put(musicaFile);

    const capaURL = await capaRef.getDownloadURL();
    const musicaURL = await musicaRef.getDownloadURL();

    await db.collection("playlists").add({
      uid: userUID,
      nome: nomeMusica,
      artista: userNameEl.textContent,
      capa: capaURL,
      musica: musicaURL,
      publica: isPublica
    });

    alert("Playlist criada com sucesso!");

    playlistForm.reset();
    loadPlaylists();
  } catch (error) {
    console.error("Erro ao criar playlist:", error);
    alert("Erro ao criar playlist: " + error.message);
  } finally {
    const btn = playlistForm.querySelector("button[type='submit']");
    btn.disabled = false;
    btn.textContent = "Criar Playlist";
  }
};
